<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agro Task Log - Farm & Inventory Management</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Agricultural Task & Inventory Management System - Track farm operations, manage inventory, log tasks with photos">
    <meta name="theme-color" content="#2d5016">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AgroLog">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- App Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%232d5016'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='70' fill='%23fff'%3Eüå±%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%232d5016' rx='40'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='100' fill='%23fff'%3Eüå±%3C/text%3E%3C/svg%3E">
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ALL YOUR EXISTING CSS STAYS HERE - 3,000+ LINES */
        /* ... [Your complete CSS from earlier] ... */
        
        /* INVENTORY SPECIFIC STYLES - ADD THESE AT THE END */
        .inventory-item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--bg);
            border-radius: 8px;
            align-items: center;
        }
        
        .stock-level {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .stock-level.high { background: #e8f5e9; color: #2e7d32; }
        .stock-level.medium { background: #fff3e0; color: #ef6c00; }
        .stock-level.low { background: #ffebee; color: #c62828; }
        
        .inventory-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
        }
        
        .inventory-card.low-stock {
            border-left-color: #ff9800;
            background: linear-gradient(to right, #fff3e0 0%, white 50%);
        }
        
        .inventory-card.out-of-stock {
            border-left-color: #f44336;
            background: linear-gradient(to right, #ffebee 0%, white 50%);
        }
        
        .inventory-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .inventory-tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .inventory-tab-content.active {
            display: block;
        }
        
        .item-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px var(--shadow);
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px var(--shadow);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .item-code {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .item-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .item-stat {
            text-align: center;
            padding: 10px;
            background: var(--bg);
            border-radius: 8px;
        }
        
        .item-stat-label {
            font-size: 0.85em;
            color: var(--text-light);
            margin-bottom: 5px;
        }
        
        .item-stat-value {
            font-size: 1.2em;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }
        
        .barcode-scanner {
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
            border: 3px dashed var(--border);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            background: var(--bg);
        }
        
        .scanner-placeholder {
            font-size: 4em;
            margin-bottom: 15px;
        }
        
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .quick-action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-restock { background: #4caf50; color: white; }
        .btn-adjust { background: #2196f3; color: white; }
        .btn-transfer { background: #9c27b0; color: white; }
        .btn-history { background: #ff9800; color: white; }
        
        .usage-chart {
            height: 200px;
            background: var(--bg);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            position: relative;
        }
        
        .chart-bar-horizontal {
            height: 30px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            padding-right: 10px;
            justify-content: flex-end;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            transition: width 0.5s ease;
        }
        
        .supplier-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #1565c0;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .expiry-badge {
            display: inline-block;
            background: #ffebee;
            color: #c62828;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üå± Agro Task & Inventory Log</h1>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchView('entry')">
                    üìù New Task
                </button>
                <button class="nav-tab" onclick="switchView('inventory')">
                    üì¶ Inventory
                </button>
                <button class="nav-tab" onclick="switchView('stats')">
                    üìä Statistics
                </button>
                <button class="nav-tab" onclick="switchView('records')">
                    üìã Records
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- VIEW 1: NEW TASK ENTRY -->
        <div id="entryView" class="view active">
            <div class="form-card">
                <h2 class="view-title">üìù New Task Entry</h2>
                
                <div class="info-note">
                    <strong>üí° Quick Start Entry</strong>
                    Link inventory items to auto-deduct stock when task is completed!
                </div>

                <form id="taskForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">üìÖ Date</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label for="day">üìÜ Day</label>
                            <input type="text" id="day" readonly>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="taskType">üåæ Task Type</label>
                        <select id="taskType" required onchange="toggleInventorySection()">
                            <option value="">Select task type...</option>
                            <option value="FERTILIZER">üåø FERTILIZER</option>
                            <option value="PLANTING">üå± PLANTING</option>
                            <option value="INDUCE">üíß INDUCE</option>
                            <option value="HARVEST">üåæ HARVEST</option>
                            <option value="WEED">üåø WEED</option>
                            <option value="SUCKER">‚úÇÔ∏è SUCKER</option>
                            <option value="LAND PREPARATION">üöú LAND PREPARATION</option>
                            <option value="INVENTORY_CHECK">üì¶ INVENTORY CHECK</option>
                        </select>
                    </div>

                    <!-- INVENTORY USAGE SECTION -->
                    <div class="form-group" id="inventoryUsageSection" style="display: none;">
                        <label>üì¶ Inventory Usage</label>
                        <div class="info-note" style="margin-bottom: 15px; font-size: 0.9em;">
                            üí° Items will be auto-deducted when task is marked as completed
                        </div>
                        <div class="inventory-usage-list" id="inventoryUsageList">
                            <!-- Dynamic inventory items will be added here -->
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addInventoryItemRow()" style="margin-top: 10px;">
                            ‚ûï Add Inventory Item
                        </button>
                    </div>

                    <div class="form-group" id="cropTypeGroup" style="display: none;">
                        <label for="cropType">üçç Crop Type (for INDUCE)</label>
                        <select id="cropType">
                            <option value="">Select crop type...</option>
                            <option value="SG1">SG1 (Harvest in 125 days)</option>
                            <option value="MD2">MD2 (Harvest in 145 days)</option>
                        </select>
                        <div class="info-note" style="margin-top: 10px; font-size: 0.9em;">
                            üí° <strong>Auto-Schedule:</strong> A HARVEST task will be automatically created!
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="timeStart">‚è∞ Time Start</label>
                            <input type="time" id="timeStart" required>
                        </div>
                        <div class="form-group">
                            <label for="timeEnd">‚è±Ô∏è Time End <span class="optional">(add later)</span></label>
                            <input type="time" id="timeEnd">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="operator">üë§ Operator Name</label>
                        <input type="text" id="operator" placeholder="Enter operator name" required>
                    </div>

                    <div class="form-group">
                        <label for="workNotes">üìã Work Notes</label>
                        <textarea id="workNotes" placeholder="Describe the work performed, area covered, materials used..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label>üì∏ Before Work Photos <span class="optional">(optional)</span></label>
                        <div class="file-upload">
                            <div class="file-upload-icon">üì∑</div>
                            <div class="file-upload-text">
                                <strong>Upload photos before starting work</strong><br>
                                <small>PNG, JPG up to 10MB each</small>
                            </div>
                            <input type="file" id="beforePhotosEntry" accept="image/*" multiple>
                        </div>
                        <div class="image-preview" id="beforePhotosEntryPreview"></div>
                    </div>

                    <div class="form-group">
                        <label for="weather">üå§Ô∏è Weather Condition</label>
                        <input type="text" id="weather" placeholder="e.g., Sunny, 28¬∞C, light breeze" required>
                    </div>

                    <div class="form-group">
                        <label for="status">‚úÖ Status</label>
                        <select id="status" required>
                            <option value="Pending">‚è≥ Pending</option>
                            <option value="In Progress">üîÑ In Progress</option>
                            <option value="Completed">‚úÖ Completed</option>
                            <option value="On Hold">‚è∏Ô∏è On Hold</option>
                        </select>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">
                            üíæ Save Task
                        </button>
                        <button type="reset" class="btn btn-secondary">
                            üîÑ Clear Form
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- VIEW 2: INVENTORY MANAGEMENT -->
        <div id="inventoryView" class="view">
            <h2 class="view-title">üì¶ Inventory Management</h2>
            
            <!-- Quick Stats -->
            <div class="stats-summary">
                <div class="stats-compact-grid">
                    <div class="stat-compact">
                        <div class="stat-compact-value" id="totalInventoryItems">0</div>
                        <div class="stat-compact-label">Total Items</div>
                    </div>
                    <div class="stat-compact">
                        <div class="stat-compact-value" id="lowStockCount">0</div>
                        <div class="stat-compact-label">Low Stock</div>
                    </div>
                    <div class="stat-compact">
                        <div class="stat-compact-value" id="totalInventoryValue">$0</div>
                        <div class="stat-compact-label">Total Value</div>
                    </div>
                    <div class="stat-compact">
                        <div class="stat-compact-value" id="outOfStockCount">0</div>
                        <div class="stat-compact-label">Out of Stock</div>
                    </div>
                </div>
            </div>
            
            <!-- Inventory Tabs -->
            <div class="inventory-tabs">
                <button class="nav-tab active" onclick="switchInventoryTab('items')">üìã All Items</button>
                <button class="nav-tab" onclick="switchInventoryTab('lowstock')">‚ö†Ô∏è Low Stock</button>
                <button class="nav-tab" onclick="switchInventoryTab('transactions')">üîÑ Transactions</button>
                <button class="nav-tab" onclick="switchInventoryTab('reports')">üìä Reports</button>
                <button class="nav-tab" onclick="switchInventoryTab('newitem')">‚ûï New Item</button>
            </div>
            
            <!-- Inventory Items Tab -->
            <div id="inventoryItemsTab" class="inventory-tab-content active">
                <div class="search-box" style="margin-bottom: 20px;">
                    <input type="text" id="inventorySearch" placeholder="Search items by name, code, or category..." oninput="searchInventoryItems()">
                </div>
                <div class="filter-group" style="margin-bottom: 20px;">
                    <button class="filter-btn active" onclick="filterInventory('all')">All</button>
                    <button class="filter-btn" onclick="filterInventory('FERTILIZER')">Fertilizers</button>
                    <button class="filter-btn" onclick="filterInventory('CHEMICAL')">Chemicals</button>
                    <button class="filter-btn" onclick="filterInventory('SEEDS')">Seeds</button>
                    <button class="filter-btn" onclick="filterInventory('TOOLS')">Tools</button>
                    <button class="filter-btn" onclick="filterInventory('OTHER')">Other</button>
                </div>
                <div id="inventoryItemsList"></div>
            </div>
            
            <!-- Low Stock Tab -->
            <div id="inventoryLowStockTab" class="inventory-tab-content">
                <div class="info-note" style="margin-bottom: 20px;">
                    ‚ö†Ô∏è <strong>Items below minimum stock level</strong> - Consider restocking soon!
                </div>
                <div id="lowStockItemsList"></div>
            </div>
            
            <!-- Transactions Tab -->
            <div id="inventoryTransactionsTab" class="inventory-tab-content">
                <div class="filter-group" style="margin-bottom: 20px;">
                    <button class="filter-btn active" onclick="filterTransactions('all')">All</button>
                    <button class="filter-btn" onclick="filterTransactions('USAGE')">Usage</button>
                    <button class="filter-btn" onclick="filterTransactions('RESTOCK')">Restock</button>
                    <button class="filter-btn" onclick="filterTransactions('ADJUSTMENT')">Adjustment</button>
                </div>
                <div id="inventoryTransactionsList"></div>
            </div>
            
            <!-- Reports Tab -->
            <div id="inventoryReportsTab" class="inventory-tab-content">
                <div class="chart-container">
                    <div class="chart-title">Stock Value by Category</div>
                    <div id="inventoryValueChart"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Monthly Usage Trends</div>
                    <div id="usageTrendChart"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Top 10 Consumed Items (Last 30 Days)</div>
                    <div id="topConsumedChart"></div>
                </div>
            </div>
            
            <!-- New Item Tab -->
            <div id="inventoryNewItemTab" class="inventory-tab-content">
                <div class="form-card">
                    <h3>‚ûï Add New Inventory Item</h3>
                    <form id="inventoryItemForm" onsubmit="saveInventoryItem(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="itemCode">Item Code</label>
                                <input type="text" id="itemCode" placeholder="e.g., FERT-001" required>
                            </div>
                            <div class="form-group">
                                <label for="itemName">Item Name</label>
                                <input type="text" id="itemName" placeholder="e.g., Urea 46-0-0" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="itemCategory">Category</label>
                                <select id="itemCategory" required>
                                    <option value="">Select category...</option>
                                    <option value="FERTILIZER">Fertilizer</option>
                                    <option value="CHEMICAL">Chemical</option>
                                    <option value="SEEDS">Seeds</option>
                                    <option value="TOOLS">Tools</option>
                                    <option value="EQUIPMENT">Equipment</option>
                                    <option value="OTHER">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="itemSubCategory">Sub-Category</label>
                                <input type="text" id="itemSubCategory" placeholder="e.g., Nitrogen, Herbicide">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="currentStock">Current Stock</label>
                                <input type="number" id="currentStock" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="itemUnit">Unit</label>
                                <select id="itemUnit" required>
                                    <option value="kg">kg</option>
                                    <option value="g">g</option>
                                    <option value="L">Liter</option>
                                    <option value="ml">ml</option>
                                    <option value="bags">Bags</option>
                                    <option value="pieces">Pieces</option>
                                    <option value="units">Units</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="minStock">Minimum Stock Level</label>
                                <input type="number" id="minStock" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="maxStock">Maximum Stock Level</label>
                                <input type="number" id="maxStock" step="0.01" min="0" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="unitPrice">Unit Price ($)</label>
                                <input type="number" id="unitPrice" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="supplier">Supplier</label>
                                <input type="text" id="supplier" placeholder="Supplier name">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="storageLocation">Storage Location</label>
                            <input type="text" id="storageLocation" placeholder="e.g., Store Room A, Shelf 3">
                        </div>
                        
                        <div class="form-group">
                            <label for="itemNotes">Notes</label>
                            <textarea id="itemNotes" placeholder="Special instructions, handling notes..."></textarea>
                        </div>
                        
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">üíæ Save Item</button>
                            <button type="reset" class="btn btn-secondary">üîÑ Clear Form</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- VIEW 3: STATISTICS -->
        <div id="statsView" class="view">
            <h2 class="view-title">üìä Task Statistics Dashboard</h2>
            
            <!-- Compact Summary Box -->
            <div class="stats-summary">
                <div class="stats-summary-title">üìã Quick Overview</div>
                <div class="stats-compact-grid">
                    <div class="stat-compact">
                        <div class="stat-compact-value" id="totalTasks">0</div>
                        <div class="stat-compact-label">Total Tasks</div>
                    </div>
                    <div class="stat-compact">
                        <div class="stat-compact-value" id="completedTasks">0</div>
                        <div class="stat-compact-label">Completed</div>
                    </div>
                    <div class="stat-compact">
                        <div class="stat-compact-value" id="progressTasks">0</div>
                        <div class="stat-compact-label">In Progress</div>
                    </div>
                    <div class="stat-compact">
                        <div class="stat-compact-value" id="pendingTasks">0</div>
                        <div class="stat-compact-label">Pending</div>
                    </div>
                    <div class="stat-compact">
                        <div class="stat-compact-value" id="todayTasks">0</div>
                        <div class="stat-compact-label">Today</div>
                    </div>
                    <div class="stat-compact">
                        <div class="stat-compact-value" id="totalPhotos">0</div>
                        <div class="stat-compact-label">Photos</div>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Tasks by Type</div>
                <div id="taskTypeChart"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Monthly Activity</div>
                <div id="monthlyChart"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">üìä Activity Details by Task Type</div>
                <div id="taskTypeDetails"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">üìÖ Recent Activity Log</div>
                <div id="recentActivityLog"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">üë• Operator Performance</div>
                <div id="operatorStats"></div>
            </div>
        </div>

        <!-- VIEW 4: TASK RECORDS -->
        <div id="recordsView" class="view">
            <h2 class="view-title">üìã Task Records</h2>
            
            <div class="records-header">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search by operator, notes, or weather...">
                </div>
                <div class="filter-group">
                    <button class="filter-btn active" onclick="filterRecords('all')">All</button>
                    <button class="filter-btn" onclick="filterRecords('FERTILIZER')">Fertilizer</button>
                    <button class="filter-btn" onclick="filterRecords('PLANTING')">Planting</button>
                    <button class="filter-btn" onclick="filterRecords('HARVEST')">Harvest</button>
                    <button class="filter-btn" onclick="filterRecords('WEED')">Weed</button>
                    <button class="filter-btn" onclick="filterRecords('SUCKER')">Sucker</button>
                    <button class="filter-btn" onclick="filterRecords('LAND PREPARATION')">Land Prep</button>
                </div>
            </div>

            <div class="records-list" id="recordsList">
                <div class="empty-state">
                    <div class="empty-state-icon">üìù</div>
                    <h3>No tasks recorded yet</h3>
                    <p>Start by adding your first task in the New Task Entry view</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS FOR INVENTORY -->
    
    <!-- Restock Modal -->
    <div id="restockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>üì¶ Restock Item</span>
                <button class="modal-close" onclick="closeModal('restockModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="restockItemInfo" style="margin-bottom: 20px;"></div>
                <div class="form-group">
                    <label for="restockQuantity">Quantity to Add</label>
                    <input type="number" id="restockQuantity" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label for="restockSupplier">Supplier</label>
                    <input type="text" id="restockSupplier" placeholder="Supplier name">
                </div>
                <div class="form-group">
                    <label for="restockCost">Total Cost ($)</label>
                    <input type="number" id="restockCost" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="restockNotes">Notes</label>
                    <textarea id="restockNotes" placeholder="Invoice number, quality notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('restockModal')">Cancel</button>
                <button class="btn-save" onclick="saveRestock()">Add to Stock</button>
            </div>
        </div>
    </div>
    
    <!-- Adjust Stock Modal -->
    <div id="adjustStockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>üìä Adjust Stock</span>
                <button class="modal-close" onclick="closeModal('adjustStockModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="adjustItemInfo" style="margin-bottom: 20px;"></div>
                <div class="form-group">
                    <label for="adjustType">Adjustment Type</label>
                    <select id="adjustType">
                        <option value="ADD">Add Stock (+)</option>
                        <option value="REMOVE">Remove Stock (-)</option>
                        <option value="SET">Set Exact Amount (=)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="adjustQuantity">Quantity</label>
                    <input type="number" id="adjustQuantity" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="adjustReason">Reason</label>
                    <textarea id="adjustReason" placeholder="Why is this adjustment needed?" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('adjustStockModal')">Cancel</button>
                <button class="btn-save" onclick="saveAdjustment()">Apply Adjustment</button>
            </div>
        </div>
    </div>
    
    <!-- Item History Modal -->
    <div id="itemHistoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>üìú Item History</span>
                <button class="modal-close" onclick="closeModal('itemHistoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="historyItemInfo" style="margin-bottom: 20px;"></div>
                <div id="itemHistoryList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- EXISTING MODALS (Keep from your original code) -->
    <div id="completeModal" class="modal">
        <!-- ... your existing complete modal ... -->
    </div>
    
    <div id="statusModal" class="modal">
        <!-- ... your existing status modal ... -->
    </div>
    
    <div id="photosModal" class="modal">
        <!-- ... your existing photos modal ... -->
    </div>

    <button class="export-btn" onclick="exportToExcel()">
        üì• Export to Excel
    </button>
    
    <button class="install-btn" id="installButton" style="display: none;">
        üì± Install App
    </button>

    <div class="toast" id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // ==================== GLOBAL VARIABLES ====================
        let tasks = JSON.parse(localStorage.getItem('agroTasks')) || [];
        let inventoryItems = JSON.parse(localStorage.getItem('agroInventoryItems')) || [];
        let inventoryTransactions = JSON.parse(localStorage.getItem('agroInventoryTransactions')) || [];
        let currentFilter = 'all';
        let editingTaskId = null;
        let editingInventoryItemId = null;
        let beforeWorkPhotosData = [];
        let afterWorkPhotosData = [];
        let additionalPhotosData = [];
        let beforePhotosEntryData = [];
        let currentInventoryTab = 'items';
        let inventoryFilter = 'all';

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            updateDayField();
            
            // Initialize stats and views
            updateStats();
            updateInventoryStats();
            renderRecords();
            renderCharts();
            renderInventoryItems();
            renderInventoryTransactions();
            
            // Setup event listeners
            setupEventListeners();
            
            // Check for PWA install prompt
            checkPWAInstall();
        });

        // ==================== VIEW MANAGEMENT ====================
        function switchView(view) {
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            // Show selected view
            document.getElementById(view + 'View').classList.add('active');
            
            // Update active tab
            event.target.classList.add('active');
            
            // Refresh data if needed
            if (view === 'stats') {
                renderCharts();
            } else if (view === 'inventory') {
                updateInventoryStats();
                renderInventoryItems();
                renderInventoryCharts();
            } else if (view === 'records') {
                renderRecords();
            }
        }

        function switchInventoryTab(tab) {
            currentInventoryTab = tab;
            document.querySelectorAll('.inventory-tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.inventory-tabs .nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById('inventory' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tab === 'reports') {
                renderInventoryCharts();
            } else if (tab === 'lowstock') {
                renderLowStockItems();
            }
        }

        // ==================== TASK MANAGEMENT ====================
        // [Your existing task management functions - keep all of them]
        // ... calculateDuration, completeTask, saveCompletion, editTaskStatus, etc.

        // ==================== INVENTORY MANAGEMENT ====================
        
        function toggleInventorySection() {
            const taskType = document.getElementById('taskType').value;
            const inventorySection = document.getElementById('inventoryUsageSection');
            const inventoryTasks = ['FERTILIZER', 'INDUCE', 'WEED', 'PLANTING'];
            
            if (inventoryTasks.includes(taskType)) {
                inventorySection.style.display = 'block';
                loadInventoryForTask(taskType);
            } else {
                inventorySection.style.display = 'none';
                document.getElementById('inventoryUsageList').innerHTML =
